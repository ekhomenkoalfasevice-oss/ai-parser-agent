"""Forecast generation helpers."""

from __future__ import annotations

from datetime import date, datetime
from zoneinfo import ZoneInfo

from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from app.db.models import Forecast, ForecastKind, User

SIGN_DATA = [
    ("–ö–æ–∑–µ—Ä–æ–≥", (1, 20)),
    ("–í–æ–¥–æ–ª–µ–π", (2, 19)),
    ("–†—ã–±—ã", (3, 21)),
    ("–û–≤–µ–Ω", (4, 20)),
    ("–¢–µ–ª–µ—Ü", (5, 21)),
    ("–ë–ª–∏–∑–Ω–µ—Ü—ã", (6, 21)),
    ("–†–∞–∫", (7, 23)),
    ("–õ–µ–≤", (8, 23)),
    ("–î–µ–≤–∞", (9, 23)),
    ("–í–µ—Å—ã", (10, 23)),
    ("–°–∫–æ—Ä–ø–∏–æ–Ω", (11, 22)),
    ("–°—Ç—Ä–µ–ª–µ—Ü", (12, 22)),
    ("–ö–æ–∑–µ—Ä–æ–≥", (12, 31)),
]

SIGN_TONES = {
    "–û–≤–µ–Ω": (
        "–ø–æ–ª—É—á–∞–µ—Ç —Å–≤–µ–∂–∏–π –∏–º–ø—É–ª—å—Å",
        "–°–∫–æ—Ä–æ—Å—Ç—å üî• ‚Äî –¥–µ–π—Å—Ç–≤—É–π —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ —Ñ–∏–∫—Å–∏—Ä—É–π –¥–µ—Ç–∞–ª–∏",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å ‚öñÔ∏è ‚Äî –¥–µ—Ä–∂–∏ —á–µ—Å—Ç–Ω–æ—Å—Ç—å –≤—ã—à–µ —ç–º–æ—Ü–∏–π",
    ),
    "–¢–µ–ª–µ—Ü": (
        "—á—É–≤—Å—Ç–≤—É–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å",
        "–ì–ª—É–±–∏–Ω–∞ üå± ‚Äî —Å–ª—É—à–∞–π —Ç–µ–ª–æ –∏ —Ä–∏—Ç–º—ã –¥–Ω—è",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å ‚öñÔ∏è ‚Äî –∏–∑–±–µ–≥–∞–π —É–ø—Ä—è–º—Å—Ç–≤–∞ –≤ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–∞—Ö",
    ),
    "–ë–ª–∏–∑–Ω–µ—Ü—ã": (
        "–ª–æ–≤–∏—Ç –∏—Å–∫—Ä—ã –∏–¥–µ–π",
        "–°–∫–æ—Ä–æ—Å—Ç—å üî• ‚Äî –¥–µ–ª–∞–π –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ø—Ä–∏–Ω—Ç—ã",
        "–ì–ª—É–±–∏–Ω–∞ üå± ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–π –æ–¥–Ω—É –æ—Å–Ω–æ–≤–Ω—É—é –º—ã—Å–ª—å",
    ),
    "–†–∞–∫": (
        "–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
        "–ì–ª—É–±–∏–Ω–∞ üå± ‚Äî —É–¥–µ–ª–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –±–ª–∏–∑–∫–∏–º",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å ‚öñÔ∏è ‚Äî –æ—Ç–¥–µ–ª—è–π –ª–∏—á–Ω–æ–µ –∏ —Ä–∞–±–æ—á–µ–µ",
    ),
    "–õ–µ–≤": (
        "—Å–∏—è–µ—Ç –∏ –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ",
        "–°–∫–æ—Ä–æ—Å—Ç—å üî• ‚Äî –±–µ—Ä–∏ –ª–∏–¥–µ—Ä—Å—Ç–≤–æ",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å ‚öñÔ∏è ‚Äî –Ω–µ –ø–µ—Ä–µ–≥–æ—Ä–∞–π –∫ –≤–µ—á–µ—Ä—É",
    ),
    "–î–µ–≤–∞": (
        "–≤–∏–¥–∏—Ç —Å–∏—Å—Ç–µ–º—É –≤–æ –≤—Å—ë–º",
        "–ì–ª—É–±–∏–Ω–∞ üå± ‚Äî —Ä–∞–∑–±–µ—Ä–∏ —Å–ø–∏—Å–∫–∏ –∏ –≤–ª–æ–∂–∏ —Å–º—ã—Å–ª",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å ‚öñÔ∏è ‚Äî –Ω–µ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–π—Å—è –Ω–∞ –º–µ–ª–æ—á–∞—Ö",
    ),
    "–í–µ—Å—ã": (
        "–∏—â–µ—Ç –±–∞–ª–∞–Ω—Å –∏ —Å–æ—é–∑–Ω–∏–∫–æ–≤",
        "–°–∫–æ—Ä–æ—Å—Ç—å üî• ‚Äî –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞–π—Å—è –≤ –ø–∞—Ä–µ",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å ‚öñÔ∏è ‚Äî –≥–æ–≤–æ—Ä–∏ —á–µ—Å—Ç–Ω–æ –æ –≥—Ä–∞–Ω–∏—Ü–∞—Ö",
    ),
    "–°–∫–æ—Ä–ø–∏–æ–Ω": (
        "—á—É–≤—Å—Ç–≤—É–µ—Ç –≥–ª—É–±–∏–Ω—É –ø—Ä–æ—Ü–µ—Å—Å–æ–≤",
        "–ì–ª—É–±–∏–Ω–∞ üå± ‚Äî –¥–æ–≤–µ—Ä—å—Å—è –∏–Ω—Ç—É–∏—Ü–∏–∏",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å ‚öñÔ∏è ‚Äî –æ—Ç—Å–µ–∫–∞–π —Ç–æ–∫—Å–∏—á–Ω–æ–µ",
    ),
    "–°—Ç—Ä–µ–ª–µ—Ü": (
        "–ø–æ–¥–Ω–∏–º–∞–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã",
        "–°–∫–æ—Ä–æ—Å—Ç—å üî• ‚Äî –ø–ª–∞–Ω–∏—Ä—É–π –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏–¥–µ–π",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å ‚öñÔ∏è ‚Äî –ø—Ä–æ–≤–µ—Ä—å —Ü–∏—Ñ—Ä—ã",
    ),
    "–ö–æ–∑–µ—Ä–æ–≥": (
        "—Å–æ–±–∏—Ä–∞–µ—Ç —Ñ–æ–∫—É—Å –∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É",
        "–ì–ª—É–±–∏–Ω–∞ üå± ‚Äî –Ω–∞—Å—Ç—Ä–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—é",
        "–°–∫–æ—Ä–æ—Å—Ç—å üî• ‚Äî –¥–µ–π—Å—Ç–≤—É–π –ø–æ —à–∞–≥–∞–º",
    ),
    "–í–æ–¥–æ–ª–µ–π": (
        "—Ç—è–Ω–µ—Ç—Å—è –∫ –∏–Ω—Å–∞–π—Ç–∞–º",
        "–°–∫–æ—Ä–æ—Å—Ç—å üî• ‚Äî –≤–∫–ª—é—á–∞–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å ‚öñÔ∏è ‚Äî –ø—Ä–æ–≥–æ–≤–æ—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã",
    ),
    "–†—ã–±—ã": (
        "–ø–ª—ã–≤—É—Ç –∑–∞ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ–º",
        "–ì–ª—É–±–∏–Ω–∞ üå± ‚Äî –¥–∞–π –º–µ—Å—Ç–æ –º–µ—á—Ç–∞–º",
        "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å ‚öñÔ∏è ‚Äî –¥–µ—Ä–∂–∏—Å—å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö",
    ),
}


def _compute_sun_sign(birth_date: date | None) -> str:
    if not birth_date:
        return "–ö–æ—Å–º–æ—Å"
    month = birth_date.month
    day = birth_date.day
    for sign, (limit_month, limit_day) in SIGN_DATA:
        if (month == limit_month and day <= limit_day) or month < limit_month:
            return sign
    return "–ö–æ–∑–µ—Ä–æ–≥"


def _level_from_date(birth_date: date | None, today: date) -> tuple[int, int, int]:
    base = today.day
    if birth_date:
        base += birth_date.month
    speed = (base % 3) + 1
    depth = ((base // 2) % 3) + 1
    caution = ((base // 3) % 3) + 1
    return speed, depth, caution


def render_short_text(
    sun_sign: str, today: date, speed: int, depth: int, caution: int
) -> str:
    tone = SIGN_TONES.get(
        sun_sign, ("–õ—É–Ω–∞ –∑–∞–¥–∞—ë—Ç –º—è–≥–∫–∏–π —Ä–∏—Ç–º", "–°–∫–æ—Ä–æ—Å—Ç—å üî• ‚Äî –Ω–∞–±–ª—é–¥–∞–π", "–ë—É–¥—å –≥–∏–±–æ–∫")
    )
    lines = [
        f"–°–µ–≥–æ–¥–Ω—è {sun_sign} {tone[0].lower()} ‚Äî –¥–æ–≤–µ—Ä—å—Å—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é –¥–Ω—è.",
        tone[1],
        tone[2],
        "–ù–∞–∂–º–∏ ¬´–†–∞—Å–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥¬ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã, –ª—é–±–æ–≤—å –∏ –∑–¥–æ—Ä–æ–≤—å–µ ‚Äî —Å–µ–π—á–∞—Å —ç—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.",
    ]
    return " ".join(lines)


async def get_or_create_short_forecast(
    session: AsyncSession, user: User
) -> Forecast:
    """Return stored short forecast or generate a new one."""
    tz_name = user.timezone or "UTC"
    zone = ZoneInfo(tz_name) if tz_name else ZoneInfo("UTC")
    today = datetime.now(tz=zone).date()

    result = await session.execute(
        select(Forecast).where(
            Forecast.user_id == user.id,
            Forecast.kind == ForecastKind.SHORT,
            Forecast.forecast_date == today,
        )
    )
    forecast = result.scalar_one_or_none()
    if forecast:
        return forecast

    sun_sign = _compute_sun_sign(user.birth_date)
    speed, depth, caution = _level_from_date(user.birth_date, today)
    text = render_short_text(sun_sign, today, speed, depth, caution)

    forecast = Forecast(
        user_id=user.id,
        kind=ForecastKind.SHORT,
        content=text,
        forecast_date=today,
        speed_level=speed,
        depth_level=depth,
        caution_level=caution,
    )
    session.add(forecast)
    await session.commit()
    await session.refresh(forecast)
    return forecast
